<meta charset=iso-8859-1>
<body id=b>
<canvas id=a width=1020 height=575>
<script src=data.js></script>
<script>

// Note: this file is encoded in ANSI, in order to encode every byte of the game's data on a 1-byte char.

// These globals are just to inform the minifier what a, b and A-V are. Don't put them in the final file.

//b=document.body;
//a=document.createElement("canvas");
//A=B=C=D=E=F=G=H=I=J=K=L=M=N=O=P=Q=R=S=T=U=V="";

// This onload function makes all the var names minifiable and waits for the fonts to load.
//onload = function(){

// GLOBALS
// =======

var 
c = a.getContext("2d"),                 // canvas context2d
badOS = /W|L/.exec(navigator.platform), // detect OS with bad flag support (Win / Linux)
state = 2,                              // 0 = title screen
question = 0,                           // current question number
questions = 1123,                       // total questions (chosen by player)
mode = 0,                               // 0 = highest score / 1 = "least errors"
error = 0,                              // error counter (in mode 1)
flags = 1,                              // enable flags
item = 0,                               // current item index
items = 0,                              // current list of questions
itemname = "",                          // current item name
nameparts = 0,                          // current item name parts
dataset = 0,                            // current dataset
lastdataset = 3,                        // previous dataset

// FUNCTIONS
// =========


// Draw a screen
draw = function(){

  // Reset canvas, except for feedback state
  if(state != 4){
    a.width ^= 0;
  }
  
  // Black background except on map and feedback
  if(state != 3 && state != 4){
    c.fillStyle = "#123";
    c.fillRect(0, 0, 1024, 1024);
  }

  // Title screen (0)
  if(state == 0){
    
    // Stars
    c.fillStyle = "#fff";
    for(i = 500; i--;) c.beginPath(), c.arc(Math.random() * 1020, Math.random() * 600, Math.random() + .5, 0, 7), c.fill(); 
    
    // 2
    c.font = "600px impact";
    c.fillStyle = "#07d";
    c.fillText(2, 660, 550);
    
    // Emoji
    c.font = "260px impact";
    c.fillText("\u{1f30d}", 195, 410);
    
    c.font = "50px impact";
    c.fillText("\u{1f312}", 700, 220);
    
    // GE ... QUIZ
    c.fillStyle = "#fff";
    c.font = "200px impact";
    c.fillText("GE       QUIZ", 50, 405);
    c.lineWidth = 6;
    c.strokeText("GE       QUIZ", 50, 405);
    
    // PLAY
    c.fillStyle = "#000";
    c.font = "70px impact";
    c.fillText("\u25b8PLAY\u25c2", 685, 540);
  }
  
  // Flags on Windows and Linux (10)
  else if(state == 10){
  
    c.fillStyle = "#fff";
    c.font = "110px impact,f";
    
    c.fillText("Enable flags?", 200, 150);
    c.fillText("\u{1f1fa}\u{1f1f8}", 450, 320);
    c.fillText("\u25b8OK       \u25b8no", 210, 500);
  }
  
  // Menu (1)
  else if(state == 1){
  
    c.fillStyle = "#fff";
    c.font = "110px impact";
    
    c.fillText("Game mode", 60, 150);
    
    c.font = "70px impact";
    
    c.fillText("\u25b8Highest score", 50, 280);
    c.fillText("\u25b8Minimum errors", 50, 460);
    
    c.font = "35px impact";
    
    c.fillText("Answer 25 to 1000 questions", 110, 330);
    c.fillText("Play until you reach 50,000km of errors", 110, 510);      
  }
  
  // High score submenu (11)
  else if(state == 11){
  
    c.fillStyle = "#fff";
    c.font = "110px impact";
    
    c.fillText("Highest score", 60, 150);
    
    c.font = "60px impact";
    
    c.fillText("\u25b825 questions", 50, 270);
    c.fillText("\u25b850 questions", 50, 400);
    c.fillText("\u25b8100 questions", 50, 530);
    
    c.fillText("\u25b8250 questions", 550, 270);
    c.fillText("\u25b8500 questions", 550, 400);
    c.fillText("\u25b81000 questions", 530, 530);
  }
  
  // Choose a question (2)
  else if(state == 2){
  
     // Pick a dataset
     // --------------
      
    // First 3 questions: country (1), capital (8), place (12)
    if(question < 3){
      dataset = [1,8,12][question];
    }
    
    // For all the other questions, the dataset is picked randomly
    else {
      dataset = lastdataset;
      
      // Try 999 times to pick another dataset than the previous one, then abandon and take the same
      for(i = 0; i < 999; i++){
      
        var random = Math.random();
      
        // 30% chance to choose country, capital or place (10% each)
        if(random < .1) dataset = 1;
        else if(random < .2) dataset = 8;
        else if(random < .3) dataset = 12;
        
        // 70% chance to choose one of the 11 other datasets (or 10 if flags are disabled)
        else {
          
          // Flags: 70% / 11 = 6.4% for datasets 0 and 4-11
          // No flags: 70% / 10 = 7% for datasets 0 and 4-10
          dataset = (4 + (~~((random - .3) / (flags ? .064 : .07)))) % (flags ? 14 : 13);
          
        }

        // If we found a new dataset not empty: keep it
        if(dataset != lastdataset && datasets[dataset][3].length > 0){
          break;
        }
        
        // Else, take the last one (it is for sure not empty but it was avoided until now)
        dataset = lastdataset;
      }
      
      // Save this dataset
      lastdataset = dataset;
    }
    
    console.log(dataset);
    
    items = datasets[dataset][3];
    
    // If no question left: go to score screen
    if(items.length == 0){
      screen = 4;
      draw();
      return;
    }
    
    // Pick a question
    // ---------------
    
    // Pick one of the first N available answers, where N represents the proportion of questions asked vs the total, + 5
    // This ensures a progressive difficulty.
    // For the first 3 questions, pick between the first 30 (they're all easy, and it makes the games less repetitive)
    item = ~~(Math.random() * Math.min(question < 3 ? 30 : 5 + ((items.length) * (question / questions)), items.length)); 
    
    // Save item's name
    itemname = 
      datasets[dataset][1] // names
      [datasets[dataset][8] * items[item] + datasets[dataset][9]] // name index index
      .toUpperCase();

    // Remove that question from the array of available questions
    items.splice(item, 1);
    
    // Display everything
    // ------------------
    
    c.fillStyle = "#fff";
    c.textAlign = "left";
    
    c.font = "40px impact";
    c.fillText("Question " + (question + 1) + (mode == 0 ? ("/" + questions) : ""), 30, 50);
    if(mode == 1 && error > 0){
      c.fillText("Error: " + error + "km", 30, 100);
    }
    
    c.textAlign = "center";
    c.font = "70px impact";
    
    // Find this ... :
    c.fillText("FIND THIS " + datasets[dataset][0] + ":", 512, 280);

    // Arrow
    c.fillText("\u25b8", 970, 560);
    
    // Question
    
    // Flag
    if(dataset == 13){
      c.font = "200px f";
      c.fillText(itemname = String.fromCodePoint(0x1F1E6 + itemname.charCodeAt(0) - 65) + String.fromCodePoint(0x1F1E6 + itemname.charCodeAt(1) - 65), 512, 470);
    }
    
    // Name
    else {
      c.font = "100px impact";
      if(itemname.length > 15){
        nameparts = itemname.match(/.{1,15}( |$)/g);
      }
      else {
        nameparts = [itemname];
      }
      
      c.fillText(nameparts[0], 512, 400);
      if(nameparts[1]){
        c.fillText(nameparts[1], 512, 500);
      }
    }
    
  
  
  }
  
  // Map (3)
  else if(state == 3){
    
  }
  
  // Feedback (4)
  else if(state == 4){
    
  }
},


// Convert a latin-1 char to int
latin2int = function(i){
  if(i){
    J = i.charCodeAt();
    J = (6E4 < J ? 0 : 255 < J ? "€‚ƒ„…†‡ˆ‰Š‹ŒŽ‘’“”•–—˜™š›œžŸ".indexOf(i) + 128 : J);
    return J;
  }
},

// Draw an item and return the closest point to the click coordinates
traceitem = function(){
},

// Draw a dataset
trace = function(){
},

// Convert pointer coords to canvas intrinsic coords (X, Y).
xy = function(e){

  // Measure canvas size on state
  w = a.offsetWidth;
  
  // Mobile
  if(e.changedTouches){
    X = e.changedTouches[0].pageX * 1024 / w;
    Y = e.changedTouches[0].pageY * 1024 / w;
  }
  
  // Desktop
  else{
    X = e.pageX * 1024 / w;
    Y = e.pageY * 1024 / w;
  }
},
  
// EVENTS
// ======

// mousemove, touchmove
onmousemove = ontouchmove = function(e){
  xy(e);
  document.title = "move " + ~~X + " " + ~~Y;
};
  
// Mouseup, touchend
onmouseup = ontouchend = function(e){
  xy(e);
  document.title = "up " + ~~X + " " + ~~Y;
  
  // On title state (0)
  if(state == 0){
    if(badOS){
      state = 10;
    }
    else {
      state = 1;
    }
    draw();
  }
  
  // On flags state (10)
  else if(state == 10){
    if(X > 510){
      flags = 0;
    }
    state = 1;
    draw();
  }
  
  // On mode state (1)
  else if(state == 1){
  
    // Least errors
    if(Y > 370) {
      questions = flags ? 1123 : 925;
      mode = 1;
      state = 2;
    }
    
    else {
      state = 11;
    }
    
    draw();
  }
  
  // On Highest score state (11)
  else if(state == 11){
    if(Y > 450){
      questions = 100;
    }
    else if(Y > 310){
      questions = 50;
    }
    else{
      questions = 25;
    }
    
    if(X > 500){
      questions *= 10;
    }
    
    state = 2;
    
    draw();
  }
  
  // On question state (2)
  else if(state == 2){
        
    state = 2;
    question++;
    draw();
  }
  
  // On map (3)
  else if(state == 3){
    state = 4;
    draw();
  }
  
  // On feedback (4) (nothing)
  
  // On score (5)
  else if(state == 5){
  
  }
  
};


// INIT
// ====

// Flags polyfill
if(badOS){
  b.className = "f";
}

// Remove Kosovo flag, because it can't be displayed properly on many browsers, even with a Web font.
datasets[13][3].splice(102, 1);

// Draw title state
draw();



//}
</script>
<style>

/* Add Noto Color emoji & Twemoji on Windows */
@font-face{font-family:f;src:url(n.ttf),url(t.ttf)}

/* Add Impact on mobile */
@font-face{font-family:impact;src:url(i.ttf)}

/* Global style */
*{margin:0;background:#123;cursor:crosshair;width:100%;overflow:hidden;max-width:177vh}

/* Flags polyfill */
.f{font-family:f}

/* Canvas radial background */
#a{background:radial-gradient(#75D1FF 50%,#0af)